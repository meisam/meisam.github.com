<p><a href="http://rspec.info">RSpec</a> is a great tool that has come to replace <code>Test::Unit</code> for many <a href="http://www.rubyonrails.com/">Rails</a> developers. <a href="http://www.zenspider.com/ZSS/Products/ZenTest/">Autotest</a> makes it go even faster, and has become an indispensable part of my development environment. However, it has always been somewhat-to-extremely difficult to use RSpec when developing Rails plugins. In this post I will walk through step-by-step how to get RSpec and Autotest working with your plugin.</p>
<p>This plugin is assuming that you are running Rails &gt;= 2.1 and have already installed RSpec and RSpec::Rails as plugins in your Rails project like so:</p>
<pre name='code' class='bash'>script/plugin install git://github.com/dchelimsky/rspec.git
script/plugin install git://github.com/dchelimsky/rspec-rails.git</pre>
<p>And also gotten RSpec up and running by calling <code>script/generate rspec</code>.</p>
<h3>Generate It</h3>
<p>Luckily, I wasn&#8217;t the first person who ever wanted to create a plugin that was tested with RSpec. <a href="http://github.com/pat-maddox/rspec-plugin-generator/tree/master">The Rspec Plugin Generator</a> will do most of the heavy lifting for us when we start out. Just install it like so:</p>
<pre name='code' class='bash'>script/plugin install git://github.com/pat-maddox/rspec-plugin-generator.git</pre>
<p>And you&#8217;re ready to get started. I&#8217;m assuming here that this is a brand new plugin, if it&#8217;s already in development you may need to run this in a fresh directory and then copy/paste files as needed to glue it together. Let&#8217;s say I&#8217;m writing a plugin called <code>new_fu</code>. I can generate an RSpec-ready plugin simply by calling:</p>
<pre name='code' class='bash'>script/generate rspec_plugin new_fu</pre>
<p>This will generate the standard plugin structure as well as some extra files:</p>
<pre name='code' class='bash'>create  vendor/plugins/new_fu/spec
create  vendor/plugins/new_fu/spec/spec_helper.rb
create  vendor/plugins/new_fu/spec/new_fu_spec.rb</pre>
<p>You can take a look at these to see how they work, but pretty simply they hook your plugin up so that it can be run with <code>rake spec:plugins</code>. Let&#8217;s add a simple example to our <code>new_fu_spec.rb</code> file:</p>
<pre name='code' class='ruby'>require File.dirname(__FILE__) + '/spec_helper'

describe "NewFu" do
  it "should have a pending spec"
end</pre>
<p>Now if you run <code>rake spec:plugins</code> you should see one pending spec. Congratulations, your plugin is now running on RSpec!</p>
<h3>Autotest Like a Champ</h3>
<p>Ok, so now we&#8217;re up and running with RSpec on our plugin. That&#8217;s great, but if you have several plugins in the same Rails app that all have specs, it starts to get messy when you run that <code>rake spec:plugins</code>. Not to mention how long it takes between runs! We need to get an autotest setup like we have for our main Rails app!</p>
<p>I struggled with getting this to work for a long time, so thanks to <a href="http://rails.aizatto.com/2007/11/19/autotest-ing-your-rails-plugin/">this post on Rails Symphonies</a> for finally pointing me in the right direction. First we need to create an <code>autotest/discover.rb</code> file in our plugin&#8217;s <code>lib</code> directory. In that file, put this code:</p>
<pre name="code" class="ruby">$:.push(File.join(File.dirname(__FILE__), %w[.. .. rspec]))  
   
Autotest.add_discovery do  
  "rspec" 
end</pre>
<p>This gets us almost exactly where we want to be. However, the first time I ran it I had two problems: some specs that I had written were strangely failing, and it wasn&#8217;t in color or following the rest of my <code>spec.opts</code> preferences from my main app!</p>
<p>To remedy this, we need a <code>spec.opts</code> in the <code>spec</code> directory of the plugin. You can either copy and paste it in from your Rails app (my recommendation if you are publishing your plugin) or you can just create a softlink back to it:</p>
<pre name='code' class='bash'>ln -s ../../../../spec/spec.opts spec.opts</pre>
<p>That&#8217;s it! Now if you run <code>autotest</code> you should be running all of the specs for your plugin just as you would if you were running them for your app. Note that this doesn&#8217;t hook in to your app&#8217;s <code>autotest</code>, which may be desirable or undesirable to your specific needs.</p>