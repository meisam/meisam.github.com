<p>So I had heard a number of times about writing RSpec macros (like those in the fantastic <a href="http://github.com/carlosbrando/remarkable">Remarkable</a> library) to ease spec writing for repetitive tasks, but the whole process seemed like more effort than it was worth. Not the case! It&#8217;s actually quite easy to write and include macros for your specs to do some of the standard heavy lifting.</p>
<p>First of all, <a href="http://www.benmabey.com/2008/06/08/writing-macros-in-rspec/">this is a great resource</a> to get started with how to write the actual macros (or custom matchers) themselves. What tripped me up was how to actually include them in my examples; monkeypatching is never a clean process and even though I knew from the comments on that post that there was a public <span class="caps">API</span> for doing it, as with many things about RSpec how to do it didn&#8217;t seem immediately obvious.</p>
<p>In my case, I was looking to define a quick <code>login!</code> macro that would allow me to easily create a before block to log in as a specified user or just as a FactoryGirl generated one in a <a href="http://github.com/mbleigh/twitter-auth">TwitterAuth</a> based app. Here&#8217;s the module I wrote and stuck in my <code>spec_helper.rb</code>:</p>
<pre class='code' name='ruby'>module LoginMacro
  def login!(user=Factory(:user))
    before do
      @current_user = user
      controller.stub!(:current_user).and_return(@current_user)
      session[:user_id] = @current_user.id
    end
  end
end</pre>
<p>So that was relatively straightforward and now what I wanted to be able to do was call it in my controller specs like this:</p>
<pre class='code' name='ruby'>describe UsersController do
  describe "#create" do
    login!
    
    it 'should etc. etc.'
  end
end</pre>
<p>As it turns out, RSpec offers the ability to add macros and matchers via the <code>config.extend</code> and <code>config.include</code> methods on the RSpec <a href="http://gitrdoc.com/rdoc/dchelimsky/rspec/cdbdeef23f3496d81799bebfd2091f0d73084138/classes/Spec/Runner/Configuration.html">configuration object</a> (extend is for class-level macros like the one I wrote here, include is for instance-level matchers). You just have to add this to your spec helper&#8217;s configuration portion:</p>
<pre name='code' class='ruby'>config.extend(LoginMacro)</pre>
<p>Voila! Now your specs will be able to use the <code>login!</code> macro to set up a user in no time. This really wasn&#8217;t any kind of grand discovery or new trick that people experienced with RSpec don&#8217;t already know, but I find that certain things can be hard to come across if you don&#8217;t already know how to use them so I thought I&#8217;d blog for the benefit of others like me.</p>