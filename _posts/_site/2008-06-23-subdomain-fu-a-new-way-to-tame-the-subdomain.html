<p>An extremely common practice for Rails applications is to provide keyed<br />
access through subdomains (i.e. http://someaccount.awesomeapp.com/). However,<br />
there has never been a real unified convention for handling this functionality.<br />
<a href="http://github.com/rails/account_location/tree/master">DHH&#8217;s Account Location</a><br />
works for some circumstances but is more tailored for a <a href="http://www.basecamphq.com/">Basecamp</a> domain model<br />
(i.e. the app is on a separate domain from all other functionality, so you<br />
can always expect a subdomain) than the more common usage of one domain only.</p>
<p>SubdomainFu aims to provide a simple, generic toolset for dealing with subdomains<br />
in Rails applications. Rather than tie the functionality to something specific<br />
like an account, SubdomainFu simply provides a foundation upon which any<br />
subdomain-keyed system can easily be built.</p>
<h3>Usage Fu</h3>
<p>SubdomainFu works by riding on top of the <span class="caps">URL</span> Rewriting engine provided with<br />
Rails. This way you can use it anywhere you normally generate URLs: through<br />
<code>url_for</code>, in named routes, and in <code>resources</code>-based routes. There&#8217;s a small<br />
amount of configuration that is needed to get you running (though the defaults<br />
should work for most).</p>
<p>To set it up, you can modify any of these settings (the defaults are shown):</p>
<pre name="code" class="ruby"># in environment.rb
  
# These are the sizes of the domain (i.e. 0 for localhost, 1 for something.com)
# for each of your environments
SubdomainFu.tld_sizes = { :development =&gt; 0,
                          :test =&gt; 0,
                          :production =&gt; 1 }

# These are the subdomains that will be equivalent to no subdomain
SubdomainFu.mirrors = ["www"]

# This is the "preferred mirror" if you would rather show this subdomain
# in the URL than no subdomain at all.
SubdomainFu.preferred_mirror = "www"</pre>
<p>Now when you&#8217;re in your application, you will have access to two useful<br />
features: a <code>current_subdomain</code> method and the <span class="caps">URL</span> Rewriting helpers.<br />
The <code>current_subdomain</code> method will give you the current subdomain or<br />
return nil if there is no subdomain or the current subdomain is a mirror:</p>
<pre name="code" class="ruby"># http://some_subdomain.myapp.com/
current_subdomain # =&gt; "some_subdomain"

# http://www.myapp.com/ or http://myapp.com/
current_subdomain # =&gt; nil

# http://some.subdomain.myapp.com
current_subdomain # =&gt; "some.subdomain"</pre>
<p>The <span class="caps">URL</span> rewriting features of SubdomainFu come through a <code>:subdomain</code> option<br />
passed to any <span class="caps">URL</span> generating method. Here are some examples (in these examples,<br />
the current page is considered to be &#8216;http://intridea.com/&#8217;):</p>
<pre name="code" class="ruby">url_for(:controller =&gt; "my_controller", 
  :action =&gt; "my_action", 
  :subdomain =&gt; "awesome") # =&gt; http://awesome.intridea.com/my_controller/my_action
  
users_url(:subdomain =&gt; false)  # =&gt; http://intridea.com/users

# The full URL will be generated if the subdomain is not the same as the
# current subdomain, regardless of whether _path or _url is used.
users_path(:subdomain =&gt; "fun") # =&gt; http://fun.intridea.com/users
users_path(:subdomain =&gt; false) # =&gt; /users</pre>
<p>While this is just a simple set of tools, it can allow the easy creation<br />
of powerful subdomain-using tools. Note that the easiest way to locally<br />
test multiple subdomains on your app is to edit <code>/etc/hosts</code> and add<br />
subdomains like so:</p>
<pre name="code">127.0.0.1	localhost subdomain1.localhost subdomain2.localhost www.localhost</pre>
<p>Adding an entry for each subdomain you want to use locally. Then you need<br />
to flush your local <span class="caps">DNS</span> cache to make sure your changes are picked up:</p>
<pre>sudo dscacheutil -flushcache</pre>
<h3>Installation</h3>
<p>SubdomainFu is available both as a traditional plugin and as a GemPlugin<br />
for Rails 2.1 and later. For a traditional plugin, install like so:</p>
<pre>script/plugin install git://github.com/mbleigh/subdomain-fu.git</pre>
<p>For a GemPlugin, add this dependency to your <code>environment.rb</code>:</p>
<pre>config.gem 'mbleigh-subdomain-fu', :source =&gt; "http://gems.github.com/", :lib =&gt; "subdomain-fu"</pre>
<h3>Implementing A Simple Account Key System</h3>
<p>Let&#8217;s take this functionality and implement a simple account-key system based<br />
off of the subdomain. We&#8217;ll start with some controller code (assuming that<br />
we have an Account model with a &#8216;subdomain&#8217; field):</p>
<pre name="code" class="ruby">class ApplicationController &lt; ActionController::Base
  protected
  
  # Will either fetch the current account or return nil if none is found
  def current_account
    @account ||= Account.find_by_subdomain(current_subdomain)
  end
  # Make this method visible to views as well
  helper_method :current_account
  
  # This is a before_filter we'll use in other controllers
  def account_required
    unless current_account
      flash[:error] = "Could not find the account '#{current_subdomain}'"
      redirect_to :controller =&gt; "site", :action =&gt; "home", :subdomain =&gt; false
    end
  end
end</pre>
<p>That&#8217;s really all we need for a basic setup, now let&#8217;s say we have a<br />
<code>ProjectsController</code> that you must specify an account to access:</p>
<pre name="code" class="ruby">class ProjectsController &lt; ApplicationController
  # Redirect users away if no subdomain is specified
  before_filter :account_required
end</pre>
<p>There&#8217;s lots more you can do with the plugin, but this is a simple use case<br />
that everyone can relate to.</p>
<h3>Resources and Plans</h3>
<p>A feature that I hoped would make it to the first release of SubdomainFu<br />
but is now a planned feature is subdomain-aware routing so that you can<br />
add conditional subdomain routes to your <code>routes.rb</code> file. Keep an eye<br />
out for more on that in the future.</p>
<p>In the meantime, the project will live at its home on <a href="http://www.actsascommunity.com/projects/subdomain-fu/">Acts As Community</a> for intermittent<br />
updates, <a href="http://github.com/mbleigh/subdomain-fu/">is available on GitHub</a> as always, and bugs/feature requests may<br />
be passed on through the <a href="http://mbleigh.lighthouseapp.com/projects/13148-subdomain-fu">Lighthouse</a>.</p>